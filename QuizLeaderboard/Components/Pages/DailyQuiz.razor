@page "/daily"
@using QuizLeaderboard.Models
@using QuizLeaderboard.Services
@using QuizLeaderboard.Data
@using Microsoft.EntityFrameworkCore
@inject IQuestionGenerator QuestionGenerator
@inject AppDbContext Db
@inject AuthService Auth
@inject UserSession Session
@rendermode InteractiveServer

<h3>Daily Quiz</h3>

@if (!Session.IsLoggedIn)
{
    <p>Please login first to access the Daily Quiz.</p>
    <NavLink class="btn btn-primary" href="/login">Go to Login</NavLink>
}
else if (_isCompletedToday)
{
    <p>Ma már kitöltötted a napi kvízt! Gyere vissza holnap 👑</p>
}
else if (_currentQuestion is null)
{
    <p>Loading question...</p>
}
else
{
    <h4>Kérdés @_currentIndex / @TotalQuestions</h4>

    <p>@_currentQuestion.Text</p>

    @for (int i = 0; i < _currentQuestion.Options.Length; i++)
    {
        <button class="btn btn-outline-primary my-2"
                disabled="@_answered"
                @onclick="(() => Answer(i))">
            @_currentQuestion.Options[i]
        </button>
    }

    @if (_answered)
    {
        <p class="@_resultClass">@_resultMessage</p>

        @if (_currentIndex < TotalQuestions)
        {
            <button class="btn btn-secondary" @onclick="NextQuestion">Next</button>
        }
        else
        {
            <button class="btn btn-success" @onclick="FinishQuiz">Finish Daily Quiz</button>
        }
    }
}

@code {
    private const int TotalQuestions = 4;

    private int _currentIndex = 1;
    private Question? _currentQuestion;
    private bool _answered = false;
    private string _resultMessage = "";
    private string _resultClass = "";
    private int _totalScore = 0;
    private bool _isCompletedToday = false;

    protected override async Task OnInitializedAsync()
    {
        // ha nincs user a sessionben, de valamiért mégis lenne mentve, itt tudnánk visszatölteni,
        // de most egyszerűben: csak Sessiont használunk
        if (!Session.IsLoggedIn)
            return;

        await CheckCompletedToday();

        if (!_isCompletedToday)
            await LoadNewQuestion();
    }

    private async Task CheckCompletedToday()
    {
        var today = DateTime.UtcNow.Date;
        var user = Session.CurrentUser!;

        _isCompletedToday = await Db.QuizResults.AnyAsync(q =>
            q.UserId == user.Id &&
            q.Mode == QuizMode.Daily &&
            q.CompletedAt >= today);
    }

    private async Task LoadNewQuestion()
    {
        var req = new QuestionRequest(
            Topic: "C# basics",
            Difficulty: "Medium",
            Count: 1,
            Mode: QuestionSourceMode.Daily
        );

        var list = await QuestionGenerator.GenerateQuestionsAsync(req);
        _currentQuestion = list.First();
        _answered = false;
        _resultMessage = "";
        _resultClass = "";
    }

    private void Answer(int index)
    {
        if (_currentQuestion is null) return;

        _answered = true;

        if (index == _currentQuestion.CorrectIndex)
        {
            _totalScore += 2;
            _resultMessage = "Correct! 🎉";
            _resultClass = "text-success";
        }
        else
        {
            _resultMessage = "Wrong ❌";
            _resultClass = "text-danger";
        }
    }

    private async Task NextQuestion()
    {
        _currentIndex++;
        await LoadNewQuestion();
    }

    private async Task FinishQuiz()
    {
        var user = Session.CurrentUser!;

        Db.QuizResults.Add(new QuizResult
        {
            UserId = user.Id,
            Score = _totalScore,
            CompletedAt = DateTime.UtcNow,
            Mode = QuizMode.Daily,
            Topic = "C# basics",
            Difficulty = "Medium"
        });

        await Db.SaveChangesAsync();

        _isCompletedToday = true;
    }
}
