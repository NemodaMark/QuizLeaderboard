@page "/duel/{DuelId:guid}"
@using Microsoft.AspNetCore.Components
@using QuizLeaderboard.Models
@using QuizLeaderboard.Services
@using QuizLeaderboard.Data
@inject DuelService DuelService
@inject UserSession Session
@inject AppDbContext Db

<h3>Duel</h3>

@if (_duel is null)
{
    <p>Loading duel...</p>
}
else if (!_isParticipant)
{
    <p>You are not part of this duel.</p>
}
else if (_isFinished)
{
    <h4>Duel Finished</h4>
    <p>Your score: <strong>@_myScore</strong></p>
    <p>Opponent score: <strong>@_opponentScore</strong></p>
}
else
{
    <h4>Question @_currentIndex / @_totalQuestions</h4>

    <p>@_currentQ.Text</p>

    @for (int i = 0; i < _currentQ.Options.Length; i++)
    {
        <button class="btn btn-outline-primary my-2 w-100"
                disabled="@_answered"
                @onclick="(() => Answer(i))">
            @_currentQ.Options[i]
        </button>
    }

    @if (_answered)
    {
        <p class="@_resultClass">@_resultMessage</p>

        @if (_currentIndex < _totalQuestions)
        {
            <button class="btn btn-secondary mt-2" @onclick="Next">Next</button>
        }
        else
        {
            <button class="btn btn-success mt-2" @onclick="Finish">Finish Duel</button>
        }
    }
}

@code {
    [Parameter] public Guid DuelId { get; set; }

    private DuelMatch? _duel;
    private bool _isParticipant;
    private DuelQuestion _currentQ = new();
    private int _currentIndex = 1;
    private int _totalQuestions;
    private bool _answered;
    private bool _isFinished;
    private int _myScore;
    private int _opponentScore;
    private string _resultMessage = "";
    private string _resultClass = "";

    protected override async Task OnInitializedAsync()
    {
        _duel = await DuelService.GetDuelAsync(DuelId);

        if (_duel is null)
            return;

        var user = Session.CurrentUser!;
        _isParticipant = (user.Id == _duel.Player1Id) || (user.Id == _duel.Player2Id);

        var ordered = _duel.Questions.OrderBy(q => q.Index).ToList();
        _totalQuestions = ordered.Count;

        _currentQ = ordered.FirstOrDefault() ?? new DuelQuestion
        {
            Text = "No questions found.",
            Options = new[] { "A", "B", "C", "D" },
            CorrectIndex = 0
        };
    }

    private void Answer(int index)
    {
        _answered = true;

        if (index == _currentQ.CorrectIndex)
        {
            _myScore++;
            _resultMessage = "Correct!";
            _resultClass = "text-success";
        }
        else
        {
            _resultMessage = "Wrong";
            _resultClass = "text-danger";
        }
    }

    private void Next()
    {
        _currentIndex++;

        var next = _duel!.Questions.FirstOrDefault(q => q.Index == _currentIndex);
        if (next is not null)
        {
            _currentQ = next;
        }

        _answered = false;
        _resultMessage = "";
        _resultClass = "";
    }

    private async Task Finish()
    {
        _isFinished = true;

        var user = Session.CurrentUser!;
        bool isP1 = user.Id == _duel!.Player1Id;

        if (isP1)
            _duel.Player1Score = _myScore;
        else
            _duel.Player2Score = _myScore;

        if (_duel.Player1Score.HasValue && _duel.Player2Score.HasValue)
            _duel.FinishedAt = DateTime.UtcNow;

        await Db.SaveChangesAsync();

        _opponentScore = isP1
            ? _duel.Player2Score ?? 0
            : _duel.Player1Score ?? 0;
    }
}
