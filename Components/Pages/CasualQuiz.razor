@page "/casual"
@using QuizLeaderboard.Models
@using QuizLeaderboard.Services
@using QuizLeaderboard.Data
@using System.Text.RegularExpressions

@inject IQuestionGenerator QuestionGenerator
@inject AppDbContext Db
@inject UserSession Session
@inject NavigationManager Nav

<h3>Casual quiz</h3>

@if (!_loaded)
{
    <p>Loading...</p>
}
else if (!Session.IsLoggedIn)
{
    <div class="alert alert-warning">
        <p><a href="/login">Log in</a> to play and earn points.</p>
    </div>
}
else
{
    <p>Playing as <strong>@Session.CurrentUser!.DisplayName</strong></p>

    <div class="mb-3">
        <label>Topic:</label>
        <select class="form-select" @bind="_selectedTopic">
            <option value="C# basics">C# basics</option>
            <option value="Web fundamentals">Web fundamentals</option>
            <option value="Databases">Databases</option>
        </select>
    </div>

    <div class="mb-3">
        <label>Difficulty:</label>
        <select class="form-select" @bind="_selectedDifficulty">
            <option>Easy</option>
            <option>Medium</option>
            <option>Hard</option>
        </select>
    </div>

    @if (_loading)
    {
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading question...</span>
        </div>
    }
    else if (_currentQuestion is null)
    {
        <button class="btn btn-primary" @onclick="StartNewQuestion">Start question</button>
    }
    else
    {
        <div class="card mb-3">
            <div class="card-body">
                <p><strong>@CleanQuestionText(_currentQuestion.Text)</strong></p>

                <div class="list-group">
                    @for (int i = 0; i < _currentQuestion.Options.Length; i++)
                    {
                        var index = i;

                        <button class="list-group-item list-group-item-action @(_answered && index == _selectedAnswer ? (index == _currentQuestion.CorrectIndex ? "list-group-item-success" : "list-group-item-danger") : "")"
                                disabled="@_answered"
                                @onclick="() => Answer(index)">
                            @CleanQuestionText(_currentQuestion.Options[i])
                            @if (_answered && index == _currentQuestion.CorrectIndex)
                            {
                                <span class="badge bg-success float-end">✓ Correct</span>
                            }
                        </button>
                    }
                </div>

                @if (_answered)
                {
                    <div class="mt-3">
                        @if (_lastCorrect)
                        {
                            <div class="alert alert-success">
                                <strong>Correct!</strong> +1 point earned (Casual mode)
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-danger">
                                <strong>Wrong answer.</strong> The correct answer was: @CleanQuestionText(_currentQuestion.Options[_currentQuestion.CorrectIndex])
                            </div>
                        }

                        <button class="btn btn-secondary mt-2" @onclick="StartNewQuestion">Next question</button>
                        <button class="btn btn-outline-secondary mt-2 ms-2" @onclick="GoBack">Back to menu</button>
                    </div>
                }
            </div>
        </div>
    }
}

@code {
    private bool _loaded;
    private bool _loading;
    private Question? _currentQuestion;
    private bool _answered;
    private bool _lastCorrect;
    private int _selectedAnswer = -1;

    private string _selectedTopic = "C# basics";
    private string _selectedDifficulty = "Medium";

    protected override async Task OnInitializedAsync()
    {
        await Session.EnsureLoadedAsync();
        _loaded = true;
    }

    private string CleanQuestionText(string text)
    {
        if (string.IsNullOrEmpty(text))
            return text;


        text = Regex.Replace(text, @"^\[(?:Local|Remote):\s*[^\]]*\]\s*", "", RegexOptions.IgnoreCase);
        
        return text.Trim();
    }

    private async Task StartNewQuestion()
    {
        _answered = false;
        _lastCorrect = false;
        _selectedAnswer = -1;
        _loading = true;

        try
        {
            var req = new QuestionRequest(
                Topic: _selectedTopic,
                Difficulty: _selectedDifficulty,
                Count: 1,
                Mode: QuestionSourceMode.Casual
            );

            var questions = await QuestionGenerator.GenerateQuestionsAsync(req);
            _currentQuestion = questions.FirstOrDefault();
        }
        catch (Exception ex)
        {
    
            _currentQuestion = new Question
            {
                Text = $"Demo question: What is C#? (Error: {ex.Message})",
                Options = new[] { "A programming language", "A database", "An operating system", "A web browser" },
                CorrectIndex = 0,
                Topic = _selectedTopic,
                Difficulty = _selectedDifficulty
            };
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task Answer(int index)
    {
        if (_currentQuestion is null || !Session.IsLoggedIn || _answered)
            return;

        _answered = true;
        _selectedAnswer = index;
        _lastCorrect = index == _currentQuestion.CorrectIndex;

        if (_lastCorrect)
        {
            try
            {
                var userId = Session.CurrentUser!.Id;

                Db.QuizResults.Add(new QuizResult
                {
                    UserId = userId,
                    Score = 1,
                    CompletedAt = DateTime.UtcNow,
                    Mode = QuizMode.Casual,
                    Topic = _currentQuestion.Topic,
                    Difficulty = _currentQuestion.Difficulty
                });

                await Db.SaveChangesAsync();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error saving quiz result: {ex.Message}");
            }
        }
    }

    private void GoBack()
    {
        Nav.NavigateTo("/");
    }
}