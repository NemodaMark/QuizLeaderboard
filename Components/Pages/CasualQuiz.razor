@page "/casual"
@using QuizLeaderboard.Models
@using QuizLeaderboard.Services
@using QuizLeaderboard.Data

@inject IQuestionGenerator QuestionGenerator
@inject AppDbContext Db
@inject UserSession Session

<h3>Casual quiz</h3>

@if (!Session.IsLoggedIn)
{
    <p><a href="/login">Log in</a> to play and earn points.</p>
}
else
{
    <p>Playing as <strong>@Session.CurrentUser!.DisplayName</strong></p>

    <div class="mb-3">
        <label>Topic:</label>
        <select class="form-select" @bind="_selectedTopic">
            <option value="C# basics">C# basics</option>
            <option value="Web fundamentals">Web fundamentals</option>
            <option value="Databases">Databases</option>
        </select>
    </div>

    <div class="mb-3">
        <label>Difficulty:</label>
        <select class="form-select" @bind="_selectedDifficulty">
            <option>Easy</option>
            <option>Medium</option>
            <option>Hard</option>
        </select>
    </div>

    @if (_currentQuestion is null)
    {
        <button class="btn btn-primary" @onclick="StartNewQuestion">Start question</button>
    }
    else
    {
        <div class="card mb-3">
            <div class="card-body">
                <p><strong>@_currentQuestion.Text</strong></p>

                <div class="list-group">
                    @for (int i = 0; i < _currentQuestion.Options.Length; i++)
                    {
                        var index = i;   // fontos: lokális másolat

                        <button class="list-group-item list-group-item-action"
                                disabled="@_answered"
                                @onclick="() => Answer(index)">
                            @_currentQuestion.Options[i]
                        </button>
                    }
                </div>

                @if (_answered)
                {
                    <p class="mt-3">
                        @if (_lastCorrect)
                        {
                            <span class="text-success">Correct! +1 point (Casual)</span>
                        }
                        else
                        {
                            <span class="text-danger">Wrong answer.</span>
                        }
                    </p>

                    <button class="btn btn-secondary mt-2" @onclick="StartNewQuestion">Next question</button>
                }
            </div>
        </div>
    }
}

@code {
    private Question? _currentQuestion;
    private bool _answered;
    private bool _lastCorrect;

    private string _selectedTopic = "C# basics";
    private string _selectedDifficulty = "Medium";

    private async Task StartNewQuestion()
    {
        _answered = false;
        _lastCorrect = false;

        var req = new QuestionRequest(
            Topic: _selectedTopic,
            Difficulty: _selectedDifficulty,
            Count: 1,
            Mode: QuestionSourceMode.Casual
        );

        var questions = await QuestionGenerator.GenerateQuestionsAsync(req);
        _currentQuestion = questions.FirstOrDefault();
    }

    private async Task Answer(int index)
    {
        if (_currentQuestion is null || !Session.IsLoggedIn)
            return;

        _answered = true;
        _lastCorrect = index == _currentQuestion.CorrectIndex;

        if (_lastCorrect)
        {
            var userId = Session.CurrentUser!.Id;

            Db.QuizResults.Add(new QuizResult
            {
                UserId = userId,
                Score = 1,
                CompletedAt = DateTime.UtcNow,
                Mode = QuizMode.Casual,
                Topic = _currentQuestion.Topic,
                Difficulty = _currentQuestion.Difficulty
            });

            await Db.SaveChangesAsync();
        }
    }
}
