@page "/learning-quiz"
@using QuizLeaderboard.Models
@using QuizLeaderboard.Services
@using Microsoft.AspNetCore.WebUtilities
@inject IQuestionGenerator QuestionGenerator
@inject UserSession Session
@inject NavigationManager Nav

<h3>Learning quiz</h3>

@if (!_loaded)
{
    <p>Loading...</p>
}
else if (!Session.IsLoggedIn)
{
    <div class="alert alert-warning">
        You must log in to use learning quiz.</div>
    <button class="btn btn-primary" @onclick="GoToLogin">Go to Login</button>
}
else
{
    <p>Playing as <strong>@Session.CurrentUser!.DisplayName</strong></p>

    <div class="mb-3">
        <label>Topic:</label>
        <select class="form-select" @bind="_selectedTopic">
            <option value="C# basics">C# basics</option>
            <option value="Web fundamentals">Web fundamentals</option>
            <option value="Databases">Databases</option>
        </select>
    </div>

    <div class="mb-3">
        <label>Difficulty:</label>
        <select class="form-select" @bind="_selectedDifficulty">
            <option>Easy</option>
            <option>Medium</option>
            <option>Hard</option>
        </select>
    </div>

    @if (_currentQuestion is null)
    {
        <button class="btn btn-primary" @onclick="StartNewQuestion">Start question</button>
    }
    else
    {
        <div class="card mb-3">
            <div class="card-body">
                <p><strong>@_currentQuestion.Text</strong></p>

                <div class="list-group">
                    @for (int i = 0; i < _currentQuestion.Options.Length; i++)
                    {
                        <button class="list-group-item list-group-item-action"
                                disabled="@_answered"
                                @onclick="() => Answer(i)">
                            @_currentQuestion.Options[i]
                        </button>
                    }
                </div>

                @if (_answered)
                {
                    <p class="mt-3">
                        @if (_lastCorrect)
                        {
                            <span class="text-success">Correct! (learning mode, no score saved)</span>
                        }
                        else
                        {
                            <span class="text-danger">Wrong answer.</span>
                        }
                    </p>

                    <button class="btn btn-secondary mt-2" @onclick="StartNewQuestion">Next question</button>
                }
            </div>
        </div>
    }
}

@code {
    private bool _loaded;
    private Question? _currentQuestion;
    private bool _answered;
    private bool _lastCorrect;

    private string _selectedTopic = "C# basics";
    private string _selectedDifficulty = "Medium";

    protected override async Task OnInitializedAsync()
    {
        await Session.EnsureLoadedAsync();
        _loaded = true;

    
        var uri = new Uri(Nav.Uri);
        var queryParams = QueryHelpers.ParseQuery(uri.Query);
        
        if (queryParams.TryGetValue("topic", out var topic))
        {
            _selectedTopic = topic.ToString();
        }
        
        if (queryParams.TryGetValue("difficulty", out var difficulty))
        {
            _selectedDifficulty = difficulty.ToString();
        }
    }

    private async Task StartNewQuestion()
    {
        _answered = false;
        _lastCorrect = false;

        var req = new QuestionRequest(
            Topic: _selectedTopic,
            Difficulty: _selectedDifficulty,
            Count: 1,
            Mode: QuestionSourceMode.Learning
        );

        var questions = await QuestionGenerator.GenerateQuestionsAsync(req);
        _currentQuestion = questions.FirstOrDefault();
    }

    private Task Answer(int index)
    {
        if (_currentQuestion is null)
            return Task.CompletedTask;

        _answered = true;
        _lastCorrect = index == _currentQuestion.CorrectIndex;

        return Task.CompletedTask;
    }

    private void GoToLogin()
    {
        Nav.NavigateTo("/login");
    }
}