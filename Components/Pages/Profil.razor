@page "/profile"
@rendermode InteractiveServer 
@using QuizLeaderboard.Models
@using QuizLeaderboard.Services
@using QuizLeaderboard.Data
@inject AppDbContext Db
@inject UserSession Session

<h3>Your profile</h3>

@if (_user is null)
{
    <p>Please log in first.</p>
}
else
{
    <!-- BANNER FELÜL -->
    <div class="mb-3">
        <img src="@GetBannerToShow()" alt="Banner"
             style="width:100%;max-height:200px;object-fit:cover;border-radius:8px;">
    </div>

    <h4>@_user.DisplayName</h4>

    <!-- Avatar maradhat, ha használod -->
    <img src="@GetAvatarToShow()" alt="Avatar"
         style="width:80px;height:80px;border-radius:50%;">

    <div class="mt-3">
        <label>Display name</label>
        <input class="form-control" @bind="_displayName" />
    </div>

    <div class="mt-3">
        <label>Avatar URL (optional)</label>
        <input class="form-control" @bind="_avatarUrl" />
    </div>

    <!-- ÚJ: Banner URL -->
    <div class="mt-3">
        <label>Banner URL (optional)</label>
        <input class="form-control" @bind="_bannerUrl" />
        <small class="text-muted">
            You can paste a banner from pfps.gg, e.g.
            <code>https://pfps.gg/banners/12345-something</code>
        </small>
    </div>

    <button class="btn btn-primary mt-3" @onclick="SaveProfile">Save profile</button>

    @if (!string.IsNullOrEmpty(_statusMessage))
    {
        <p class="mt-2 text-success">@_statusMessage</p>
    }

    @* … a stat táblázatod maradhat alatta *@
}

@code {
    private User? _user;
    private string _displayName = "";
    private string _avatarUrl   = "";
    private string _bannerUrl   = "";
    private string _statusMessage = "";

    protected override void OnInitialized()
    {
        _user = Session.CurrentUser;
        if (_user is not null)
        {
            _displayName = _user.DisplayName;
            _avatarUrl   = _user.AvatarUrl ?? "";
            _bannerUrl   = _user.BannerUrl ?? "";
        }
    }

    private async Task SaveProfile()
    {
        if (_user is null) return;

        _user.DisplayName = _displayName.Trim();
        _user.AvatarUrl   = string.IsNullOrWhiteSpace(_avatarUrl) ? null : _avatarUrl.Trim();
        _user.BannerUrl   = string.IsNullOrWhiteSpace(_bannerUrl) ? null : _bannerUrl.Trim();

        Db.Users.Update(_user);
        await Db.SaveChangesAsync();

        _statusMessage = "Profile saved.";
    }

    private string GetAvatarToShow()
        => string.IsNullOrEmpty(_avatarUrl) ? "img/default-avatar.png" : _avatarUrl;

    private string GetBannerToShow()
        => string.IsNullOrEmpty(_bannerUrl) ? "img/default-banner.jpg" : _bannerUrl;
}
